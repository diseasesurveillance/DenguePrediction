#' Compare Predictive Models Over Future Periods
#'
#' This function performs a comparison of forecasts generated by multiple predictive models against
#' actual case data over designated future periods. It uses case data along with Google Trends data
#' as inputs and evaluates the performance of models such as ARGO, SAR, GT, and SAR_GT. Additionally,
#' a naive prediction based on the most recent period's data is included for comparison.
#'
#' @param start_d The start date for the overall period considered for model training, formatted as "YYYY-MM-DD".
#' @param end_d The end date for the overall period considered for model training, formatted as "YYYY-MM-DD".
#' @param case A data frame containing case data, expected to include at least two columns: "date" and "N_cases".
#' @param GT A data frame containing Google Trends data relevant to the cases under study.
#' @param pred_period The total number of separate future periods for which predictions will be made.
#' @param pred_length The forecast horizon for each prediction, specified in months or weeks.
#'                    Valid options are 1 or 2, indicating the length of time to forecast ahead.
#' @param lags An optional numeric vector specifying the lag periods to be applied when generating
#'             lagged data for model inputs. The default settings may vary based on the selected model.
#' @param pred_unit The unit of measurement for the prediction period, with options "Month" or "Week".
#'                  The default is "Month".
#' @param offset_GT A small positive numeric added to Google Trends data before logarithmic transformation
#'                  to manage instances of zero. The default value is 0.001.
#'
#' @return A data frame containing columns for actual case counts ('Real_value') and the predicted case
#'         counts from each of the specified models, including a column for naive model predictions.
#'         Each row corresponds to a prediction for a future period as defined by `pred_period` and
#'         `pred_length`.
#'
#' @examples
#' compare_Prediction("2020-01-01", "2020-06-30", case_data, GT_data, 2, pred_length = 1)
#' @export



compare_Prediction <- function(start_d,
                               end_d,
                               case,
                               GT,
                               pred_period,
                               pred_length = 1,
                               lags = NULL,
                               pred_unit = "Month",
                               offset_GT = 0.001){
  # Validates the prediction length
  if(pred_length != 1 & pred_length != 2) {
    stop("Error! The length of prediction should be 1 or 2 (month/s)!")
  }

  # Initializes models and prediction data frame
  models <- c("ARGO", "SAR", "GT", "SAR_GT")
  # models <- c("ARGO", "SAR_GT")
  pred <- data.frame(matrix(NA, nrow = pred_period * pred_length, ncol = length(models) + 1))

  # Iterates over models and prediction periods
  for (i in seq_along(models)) {
    for (j in 1:pred_period) {

      if(pred_unit == "Month"){
        # Calculates training and prediction periods
        start_d_train <- start_d %m+% months(j - 1)
        end_d_train <- end_d %m+% months(j - 1)
        # Prediction goes pred_length unit length for each time
        start_d_pred <- start_d %m+% months(j + pred_length - 1)
        end_d_pred <- end_d %m+% months(j + pred_length - 1)
      }else{
        # Calculates training and prediction periods
        start_d_train <- start_d %m+% weeks(j - 1)
        end_d_train <- end_d %m+% weeks(j - 1)
        # Prediction goes pred_length unit length for each time
        start_d_pred <- start_d %m+% weeks(j + pred_length - 1)
        end_d_pred <- end_d %m+% weeks(j + pred_length - 1)
      }


      # Fits the model and gets predictions
      temp_pred <- as.data.frame(get_Prediction(start_d_train, end_d_train,
                                                start_d_pred, end_d_pred,
                                                models[i], case, GT,
                                                lags = lags, # ARGO's setting
                                                pred_unit = pred_unit,
                                                offset_GT = offset_GT))
      temp_pred <- tail(temp_pred, pred_length) # Gets the last month(s) of prediction

      # Store the result based on prediction length
      if(pred_length == 1){
        if(i == 1){
          pred[j, 1:2] <- temp_pred
        }else{
          pred[j, i+1] <- temp_pred[,2]
        }
      }else{ # for pred_length == 2
        if(i == 1){
          pred[c(2*j - 1, 2*j), 1:2] <- temp_pred
        }else{
          pred[c(2*j - 1, 2*j), i+1] <- temp_pred[,2]
        }
      }

      # Prints procedure tip
      cat("This is the", j, "/", pred_period, "prediction for model", models[i], ".\r")
    }
  }

  # Get the Naive model(last month)
  start_Naive <- end_d
  if(pred_unit == "Month"){
    case <- from_Week_to_Month(case)
    end_Naive <- end_d %m+% months(pred_period)
  }else{
    end_Naive <- end_d %m+% weeks(pred_period)
  }
  pred$X6 <- lag_Gen(case,
                     start_Naive, end_Naive,
                     lags = 1, pred_unit = pred_unit)

  # Rename the dataframe
  colnames(pred) <- c("Real_value", models, "Naive")

  return(pred)
}
